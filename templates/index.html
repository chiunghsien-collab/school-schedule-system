<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ‹å°æ’èª²ç³»çµ± v7.0 - å…¨åŠŸèƒ½ç©©å®šç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --teacher-bg: #fffde7; --teacher-border: #fbc02d; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #eef2f7; padding: 20px; }
        .container { max-width: 1600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .action-btn { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-size: 14px; }
        
        /* åŒ¯å…¥å€åŸŸ */
        .import-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px dashed var(--primary); }
        .import-card h3 { margin-top: 0; font-size: 16px; color: #1565c0; }

        /* ç­ç´šé¸æ“‡å€ */
        .grade-container { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
        .grade-row { display: flex; align-items: center; margin-bottom: 5px; }
        .grade-label { width: 80px; font-weight: bold; color: #666; }
        .class-btn { border: 1px solid #ddd; background: white; padding: 5px 12px; margin: 2px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .class-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .main-grid { display: grid; grid-template-columns: 1fr 300px 1fr; gap: 20px; }
        .table-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: white; }
        table { border-collapse: collapse; width: 100%; text-align: center; table-layout: fixed; }
        th, td { border: 1px solid #ddd; height: 70px; position: relative; font-size: 14px; }
        th { background: #f1f3f4; height: 35px; }
        
        /* è€å¸«æ–¹å¡Š */
        .pool-item, .drag-item { 
            background: #e8f0fe; border: 1px solid var(--primary); 
            padding: 8px; border-radius: 6px; cursor: move; 
            user-select: none; transition: 0.2s;
        }
        .pool-item.selected { border: 3px solid #f44336 !important; background: #ffebee; box-shadow: 0 0 10px rgba(244,67,54,0.2); }
        .hours-badge { position: absolute; top: 2px; right: 2px; background: var(--primary); color: white; font-size: 10px; padding: 1px 5px; border-radius: 10px; }
        
        /* é»æ“Šé¸å–æ¨¡å¼è¦–è¦ºæç¤º */
        .drop-zone-active { background: #fffde7; border: 2px dashed var(--primary) !important; cursor: pointer; }
        .drop-zone-active:hover { background: #fff9c4; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0; color:var(--primary);">ğŸ« åœ‹å°æ’èª²ç³»çµ± v7.0</h2>
        <div>
            <label for="importFile" class="action-btn" style="background:#009688; cursor:pointer;">ğŸ“‚ åŒ¯å…¥å­˜æª”</label>
            <input type="file" id="importFile" style="display:none;" accept=".json">
            <button onclick="exportJSON()" class="action-btn" style="background:#673ab7;">ğŸ’¾ åŒ¯å‡ºå­˜æª”</button>
        </div>
    </div>

    <div class="import-section">
        <div class="import-card">
            <h3>ç¬¬ä¸€æ­¥ï¼šåŒ¯å…¥ç­ç´š Excel</h3>
            <input type="file" onchange="importClassExcel(event)" accept=".xlsx, .xls">
        </div>
        <div class="import-card">
            <h3>ç¬¬äºŒæ­¥ï¼šåŒ¯å…¥æ•™å¸« Excel</h3>
            <input type="file" onchange="importTeacherExcel(event)" accept=".xlsx, .xls">
        </div>
    </div>

    <div id="gradePanel" class="grade-container"></div>

    <div class="main-grid">
        <div class="table-card">
            <h3 id="classTitle">ğŸ“Œ ç­ç´šèª²è¡¨</h3>
            <table>
                <thead><tr><th>ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead>
                <tbody id="classTableBody"></tbody>
            </table>
        </div>
        
        <div class="table-card" ondragover="evP(event)" ondrop="handleBackDrop(event)">
            <h3>ğŸ‘¥ å¾…æ’æ•™å¸«</h3>
            <div id="poolItems"></div>
            <p style="font-size:12px; color:#999; margin-top:10px;">æç¤ºï¼šé»é¸è€å¸«å¾Œï¼Œç›´æ¥é»æ“Šèª²è¡¨æ ¼å­å³å¯æ’å…¥ã€‚</p>
        </div>

        <div class="table-card" style="background: var(--teacher-bg)">
            <h3 id="teacherTitle">ğŸ” è€å¸«è¡Œç¨‹</h3>
            <table>
                <thead><tr><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr></thead>
                <tbody id="teacherTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let db = { classes: [], teachers: [], schedules: {} };
    let currentClass = "";
    let selectedTeacher = "";
    let dragData = null; 

    window.onload = async () => {
        try {
            const resp = await fetch('/get_data');
            db = await resp.json();
            if (db.classes?.length > 0) {
                renderGradeButtons();
                selectClass(db.classes[0].name);
            }
        } catch(e) { console.log("ç­‰å¾…è³‡æ–™ä¸­..."); }
    };

    function evP(e) { e.preventDefault(); }

    function selectClass(name) { 
        currentClass = name; 
        renderGradeButtons(); 
        renderAll(); 
    }

    // é¸å–è€å¸«ï¼ˆæ”¯æ´ç‰©ç†æ‹–æ›³èˆ‡é»æ“Šé¸å–ï¼‰
    function pickTeacher(name, sub, type, oldKey = '') {
        selectedTeacher = name;
        dragData = { name, sub, type, oldKey, targetClass: currentClass };
        renderAll();
    }

    function renderAll() {
        if(!currentClass) return;
        document.getElementById('classTitle').innerText = `ğŸ“Œ ${currentClass} ç­ç´šèª²è¡¨`;
        renderClassTable();
        renderPool();
        renderTeacherTable();
    }

    function renderClassTable() {
        const body = document.getElementById('classTableBody');
        body.innerHTML = '';
        for(let p=1; p<=7; p++) {
            let tr = `<tr><td>${p}</td>`;
            for(let d=1; d<=5; d++) {
                const key = `${d}-${p}`;
                const data = db.schedules[currentClass]?.[key];
                const activeZone = dragData ? 'drop-zone-active' : '';
                
                let content = "";
                if(data) {
                    content = `<div class="drag-item" draggable="true" 
                        onpointerdown="pickTeacher('${data.name}', '${data.sub}', 'table', '${key}')"
                        ondragstart="onDs(event, 'table', '${data.name}', '${data.sub}', '${key}')">
                        ${data.sub}<br>${data.name}</div>`;
                }
                tr += `<td class="${activeZone}" ondragover="evP(event)" 
                    onclick="onCellClick('${key}')" ondrop="onDp(event, '${key}')">${content}</td>`;
            }
            body.innerHTML += tr + "</tr>";
        }
    }

    function renderPool() {
        const container = document.getElementById('poolItems');
        container.innerHTML = '';
        db.teachers.forEach(t => {
            t.assignments.filter(as => as.className === currentClass).forEach(as => {
                const used = Object.values(db.schedules[currentClass] || {}).filter(v => v.name === t.name && v.sub === as.subject).length;
                const remain = as.hours - used;
                if(remain > 0) {
                    const isSel = selectedTeacher === t.name ? 'selected' : '';
                    const div = document.createElement('div');
                    div.className = `pool-item ${isSel}`;
                    div.setAttribute('draggable', 'true');
                    div.innerHTML = `<span class="hours-badge">${remain}</span><strong>${as.subject}</strong><br>${t.name}`;
                    
                    div.onpointerdown = () => pickTeacher(t.name, as.subject, 'pool');
                    div.ondragstart = (e) => onDs(e, 'pool', t.name, as.subject);
                    container.appendChild(div);
                }
            });
        });
    }

    function renderTeacherTable() {
        const body = document.getElementById('teacherTableBody');
        body.innerHTML = '';
        document.getElementById('teacherTitle').innerText = selectedTeacher ? `ğŸ” ${selectedTeacher} è¡Œç¨‹` : "ğŸ” é»é¸è€å¸«æŸ¥çœ‹";
        for(let p=1; p<=7; p++) {
            let tr = `<tr>`;
            for(let d=1; d<=5; d++) {
                const key = `${d}-${p}`;
                let occ = null;
                for(let cN in db.schedules) {
                    if(db.schedules[cN][key]?.name === selectedTeacher) { occ = {cN, sub: db.schedules[cN][key].sub}; break; }
                }
                tr += `<td ondragover="evP(event)" ondrop="onDp(event, '${key}')" onclick="onCellClick('${key}')">
                    ${occ ? occ.cN + '<br>' + occ.sub : ''}</td>`;
            }
            body.innerHTML += tr + "</tr>";
        }
    }

    function onDs(e, type, name, sub, oldKey = '') {
        dragData = { type, name, sub, oldKey, targetClass: currentClass };
        e.dataTransfer.setData("text/plain", "dragging");
    }

    function onDp(e, newKey) {
        e.preventDefault();
        executeMove(newKey);
    }

    function onCellClick(newKey) {
        if(dragData) executeMove(newKey);
    }

    function executeMove(newKey) {
        if(!dragData) return;
        const { type, name, sub, oldKey, targetClass } = dragData;
        
        for(let cN in db.schedules) {
            if(db.schedules[cN][newKey]?.name === name && (type === 'pool' || oldKey !== newKey)) {
                alert(`âŒ è¡å ‚ï¼š${name} å·²åœ¨ ${cN} æœ‰èª²`); 
                dragData = null; renderAll(); return;
            }
        }

        if(type !== 'pool') delete db.schedules[targetClass][oldKey];
        if(!db.schedules[currentClass]) db.schedules[currentClass] = {};
        db.schedules[currentClass][newKey] = { name, sub };
        
        dragData = null; 
        renderAll(); sync();
    }

    function handleBackDrop(e) {
        if(dragData && dragData.type !== 'pool') {
            delete db.schedules[dragData.targetClass][dragData.oldKey];
            dragData = null; renderAll(); sync();
        }
    }

    async function sync() { await fetch('/save_data', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(db) }); }
    
    function renderGradeButtons() {
        const p = document.getElementById('gradePanel'); p.innerHTML = "";
        const labels = ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
        labels.forEach((g,i)=>{
            const rowClasses = db.classes.filter(c=>c.name.startsWith(i+1));
            if(rowClasses.length){
                const d = document.createElement('div');
                d.className = 'grade-row';
                d.innerHTML = `<span class="grade-label">${g}å¹´ç´šï¼š</span>`;
                rowClasses.forEach(c=>{
                    const b = document.createElement('button');
                    b.className = `class-btn ${currentClass===c.name?'active':''}`;
                    b.innerText = c.name; b.onclick = ()=>selectClass(c.name);
                    d.appendChild(b);
                });
                p.appendChild(d);
            }
        });
    }

    // Excel åŒ¯å…¥
    function importClassExcel(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            db.classes = json.map(row => ({ name: String(row['ç­ç´š']), subjects: row['ç§‘ç›®'] }));
            renderGradeButtons(); sync(); alert("âœ… ç­ç´šåŒ¯å…¥æˆåŠŸï¼");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function importTeacherExcel(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            db.teachers = [];
            json.forEach(row => {
                let t = db.teachers.find(x => x.name === row['æ•™å¸«å§“å']);
                if(!t) { t = { name: row['æ•™å¸«å§“å'], assignments: [] }; db.teachers.push(t); }
                t.assignments.push({ className: String(row['æˆèª²ç­ç´š']), subject: row['æˆèª²ç§‘ç›®'], hours: parseInt(row['æ¯é€±ç¯€æ•¸']) });
            });
            renderPool(); sync(); alert("âœ… æ•™å¸«åŒ¯å…¥æˆåŠŸï¼");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function exportJSON() {
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db, null, 2)], {type: "application/json"}));
        a.download = `èª²è¡¨å­˜æª”.json`; a.click();
    }

    document.getElementById('importFile').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = async (evt) => {
            db = JSON.parse(evt.target.result);
            await sync(); renderGradeButtons(); selectClass(db.classes[0].name);
            alert("âœ… å­˜æª”åŒ¯å…¥æˆåŠŸï¼");
        };
        reader.readAsText(e.target.files[0]);
    };
</script>
</body>
</html>
